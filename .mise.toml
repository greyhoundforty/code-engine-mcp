[tools]
python = "3.12"
usage = "latest"

[env]
_.python.venv = { path = ".venv", create = true }
PROJECT_NAME = "{{ config_root | basename }}"
PREFIX = "{{ env.PROJECT_NAME }}"
DOCKER_IMAGE = "{{ env.PREFIX }}"
CONTAINER_NAME = "{{ env.PREFIX }}-container"

[tasks."uv:reqs"]
description = "Install dependencies from requirements file"
alias = "uvr"
run = "uv pip install -r requirements.txt"

[tasks."uv:freeze"]
description = "Create requirements.txt from currently installed modules"
alias = "uvf"
run = "uv pip freeze > requirements.txt"

[tasks."uv:install"]
description = "Install pip packages"
alias = "uvi"
run = "uv pip install"

[tasks."uv:dev"]
description = "Install development dependencies"
alias = "uvd"
run = '''
uv pip install -r requirements.txt
uv pip install black flake8 mypy pytest pytest-asyncio pytest-cov bandit safety
'''

[tasks.info]
description = "Print project information"
run = '''
echo "Project: $PROJECT_NAME"
echo "Virtual Environment: $VIRTUAL_ENV"
echo "Docker Image: $DOCKER_IMAGE:$DOCKER_TAG"
echo "Container Name: $CONTAINER_NAME"
'''

# Code Quality Tasks
[tasks.lint]
description = "Run flake8 linting"
run = "flake8 ce_mcp_server.py utils.py --max-line-length=88 --extend-ignore=E203,W503"

[tasks.format]
description = "Format code with black"
run = "black ce_mcp_server.py utils.py"

[tasks."format:check"]
description = "Check code formatting without making changes"
run = "black --check ce_mcp_server.py utils.py"

[tasks.typecheck]
description = "Run mypy type checking"
run = "mypy ce_mcp_server.py utils.py --ignore-missing-imports"

[tasks.security]
description = "Run security checks"
run = '''
echo "ðŸ”’ Running bandit security scan..."
bandit -r . -f json -o bandit-report.json || true
echo "ðŸ”’ Checking for known vulnerabilities..."
safety check
'''

[tasks.quality]
description = "Run all code quality checks"
depends = ["format:check", "lint", "typecheck", "security"]
run = "echo 'âœ… All quality checks passed!'"

# Testing Tasks  
[tasks.test]
description = "Run tests"
run = "pytest tests/ -v"

[tasks."test:cov"]
description = "Run tests with coverage"
run = "pytest tests/ -v --cov=. --cov-report=html --cov-report=term"

[tasks."test:mcp:minimal"]
description = "Test minimal MCP server setup"
alias = "tmm"
run = '''
echo "ðŸ§ª Testing minimal MCP setup..."
python minimal_mcp_test.py
'''

[tasks."test:mcp"]
description = "Test MCP library imports and functionality"
alias = "tm"
run = '''
echo "ðŸ§ª Testing MCP library..."
python test_mcp_imports.py
'''

[tasks."test:server:v2"]
description = "Test alternative MCP server implementation"
alias = "ts2"
run = '''
echo "ðŸ§ª Testing alternative MCP server..."
python -c "
try:
    from ce_mcp_server_v2 import server, main
    print('âœ… Alternative MCP server imports successfully')
except Exception as e:
    print(f'âŒ Alternative MCP server import failed: {e}')
    import traceback
    traceback.print_exc()
    exit(1)
"
'''

[tasks."test:server:v3"]
description = "Test minimal MCP server implementation (without InitializationOptions)"
alias = "ts3"
run = '''
echo "ðŸ§ª Testing minimal MCP server..."
python -c "
try:
    from ce_mcp_server_v3 import server, main
    print('âœ… Minimal MCP server imports successfully')
except Exception as e:
    print(f'âŒ Minimal MCP server import failed: {e}')
    import traceback
    traceback.print_exc()
    exit(1)
"
'''

[tasks."test:servers"]
description = "Test all MCP server versions quickly"
alias = "tservers"
run = '''
echo "ðŸ§ª Testing all MCP server versions..."

echo "ðŸ“‹ Testing imports for all servers..."
python -c "
results = []

print('  Testing ce_mcp_server.py...')
try:
    from ce_mcp_server import server, main
    results.append(('Original', 'âœ…'))
except Exception as e:
    results.append(('Original', f'âŒ {e}'))

print('  Testing ce_mcp_server_v2.py...')
try:
    from ce_mcp_server_v2 import server, main
    results.append(('V2 Alternative', 'âœ…'))
except Exception as e:
    results.append(('V2 Alternative', f'âŒ {e}'))

print('  Testing ce_mcp_server_v3.py...')
try:
    from ce_mcp_server_v3 import server, main
    results.append(('V3 Minimal', 'âœ…'))
except Exception as e:
    results.append(('V3 Minimal', f'âŒ {e}'))

print('\nðŸ“ Results Summary:')
for name, result in results:
    print(f'  {name}: {result}')

working_count = sum(1 for _, result in results if result == 'âœ…')
print(f'\nðŸŽ¯ {working_count}/3 server versions working')

if working_count > 0:
    print('\nðŸ’¡ Recommended order to try:')
    if any('V3 Minimal' in name and result == 'âœ…' for name, result in results):
        print('  1. ce_mcp_server_v3.py (minimal, most likely to work)')
    if any('V2 Alternative' in name and result == 'âœ…' for name, result in results):
        print('  2. ce_mcp_server_v2.py (alternative approach)')
    if any('Original' in name and result == 'âœ…' for name, result in results):
        print('  3. ce_mcp_server.py (original implementation)')
"
'''

[tasks."test:init"]
description = "Test InitializationOptions fix"
alias = "ti"
run = '''
echo "ðŸ§ª Testing InitializationOptions fix..."
python test_init_options.py
'''

[tasks."run:best"]
description = "Run the best working MCP server version"
alias = "rb"
run = '''
echo "ðŸš€ Finding and running the best MCP server version..."

echo "ðŸ“‹ Testing which servers work..."
python -c "
import sys

# Test servers in order of preference
servers = [
    ('ce_mcp_server_v3.py', 'V3 Minimal'),
    ('ce_mcp_server_v2.py', 'V2 Alternative'), 
    ('ce_mcp_server.py', 'V1 Original')
]

working_server = None

for filename, name in servers:
    try:
        module_name = filename.replace('.py', '')
        module = __import__(module_name)
        print(f'  âœ… {name} ({filename}) - imports successfully')
        if working_server is None:
            working_server = filename
    except Exception as e:
        print(f'  âŒ {name} ({filename}) - import failed: {e}')

if working_server:
    print(f'\nðŸŽ¯ Best server: {working_server}')
    print(f'ðŸ“ Starting {working_server}...')
    sys.exit(0)
else:
    print('\nâŒ No working servers found!')
    sys.exit(1)
"

# Get the result and run the best server
if [ $? -eq 0 ]; then
  # For now, default to v3 since our test above doesn't actually run them
  echo "ðŸš€ Starting ce_mcp_server_v3.py (with InitializationOptions fix)..."
  python ce_mcp_server_v3.py
else
  echo "âŒ Could not determine best server to run"
  exit 1
fi
'''

# Docker Tasks
[tasks."docker:build"]
description = "Build Docker image for MCP server"
alias = "db"
run = '''
echo "ðŸ”¨ Building Docker image: $DOCKER_IMAGE:$DOCKER_TAG"
docker build -t $DOCKER_IMAGE:$DOCKER_TAG .
echo "âœ… Docker image built successfully"
'''

[tasks."docker:build:multi"]
description = "Build multi-platform Docker image"
run = '''
echo "ðŸ”¨ Building multi-platform Docker image..."
docker buildx build --platform linux/amd64,linux/arm64 -t $DOCKER_IMAGE:$DOCKER_TAG .
'''

[tasks."docker:run"]
description = "Run MCP server in Docker container"
alias = "dr"
run = '''
echo "ðŸš€ Starting MCP server container: $CONTAINER_NAME"
if [ -z "$IBMCLOUD_API_KEY" ]; then
  echo "âŒ ERROR: IBMCLOUD_API_KEY environment variable not set"
  echo "Please set it with: export IBMCLOUD_API_KEY='your-api-key'"
  exit 1
fi

# Stop existing container if running
docker stop $CONTAINER_NAME 2>/dev/null || true
docker rm $CONTAINER_NAME 2>/dev/null || true

# Run new container
docker run -d \
  --name $CONTAINER_NAME \
  -e IBMCLOUD_API_KEY="$IBMCLOUD_API_KEY" \
  -e PYTHONUNBUFFERED=1 \
  -e LOG_LEVEL=INFO \
  --restart unless-stopped \
  $DOCKER_IMAGE:$DOCKER_TAG

echo "âœ… Container started successfully"
echo "ðŸ“‹ Check status: docker ps"
echo "ðŸ“ View logs: docker logs $CONTAINER_NAME"
'''

[tasks."docker:run:interactive"]
description = "Run MCP server interactively for debugging"
alias = "dri"
run = '''
echo "ðŸš€ Starting MCP server container interactively..."
if [ -z "$IBMCLOUD_API_KEY" ]; then
  echo "âŒ ERROR: IBMCLOUD_API_KEY environment variable not set"
  exit 1
fi

docker run -it --rm \
  --name $CONTAINER_NAME-debug \
  -e IBMCLOUD_API_KEY="$IBMCLOUD_API_KEY" \
  -e PYTHONUNBUFFERED=1 \
  -e LOG_LEVEL=DEBUG \
  $DOCKER_IMAGE:$DOCKER_TAG
'''

[tasks."docker:shell"]
description = "Open shell in running container"
run = "docker exec -it $CONTAINER_NAME /bin/bash"

[tasks."docker:logs"]
description = "Show container logs"
alias = "dl"
run = "docker logs -f $CONTAINER_NAME"

[tasks."docker:stop"]
description = "Stop and remove container"
alias = "ds"
run = '''
echo "ðŸ›‘ Stopping container: $CONTAINER_NAME"
docker stop $CONTAINER_NAME 2>/dev/null || true
docker rm $CONTAINER_NAME 2>/dev/null || true
echo "âœ… Container stopped and removed"
'''

[tasks."docker:scan"]
description = "Scan Docker image for vulnerabilities"
run = '''
echo "ðŸ” Scanning Docker image for vulnerabilities..."
docker scout quickview $DOCKER_IMAGE:$DOCKER_TAG || echo "Docker Scout not available, skipping scan"
'''

[tasks."docker:size"]
description = "Check Docker image size"
run = "docker images $DOCKER_IMAGE:$DOCKER_TAG --format 'table {{.Repository}}\t{{.Tag}}\t{{.Size}}'"

# Development Tasks
[tasks.dev]
description = "Start development environment"
depends = ["uv:dev"]
run = '''
echo "ðŸš€ Development environment ready!"
echo "ðŸ’¡ Useful commands:"
echo "  - mise run test: Run tests"
echo "  - mise run lint: Check code style"
echo "  - mise run docker:build: Build Docker image"
echo "  - mise run docker:run:interactive: Debug container"
'''

[tasks."dev:watch"]
description = "Watch for file changes and rebuild"
run = '''
echo "ðŸ‘€ Watching for changes..."
while inotifywait -e modify -r .; do
  echo "ðŸ”„ Files changed, running quality checks..."
  mise run quality || true
done
'''

[tasks.clean]
description = "Clean up build artifacts and containers"
run = '''
echo "ðŸ§¹ Cleaning up..."
# Remove Python cache
find . -type f -name "*.pyc" -delete
find . -type d -name "__pycache__" -delete
# Remove test artifacts
rm -rf .pytest_cache htmlcov bandit-report.json
# Stop and remove containers
docker stop $CONTAINER_NAME 2>/dev/null || true
docker rm $CONTAINER_NAME 2>/dev/null || true
# Remove Docker images (uncomment if desired)
# docker rmi $DOCKER_IMAGE:$DOCKER_TAG 2>/dev/null || true
echo "âœ… Cleanup complete"
'''

# Release Tasks
[tasks."release:check"]
description = "Pre-release checks"
depends = ["quality", "test", "docker:build"]
run = '''
echo "ðŸŽ¯ Pre-release checks completed!"
echo "ðŸ“‹ Summary:"
echo "  âœ… Code quality checks passed"
echo "  âœ… Tests passed" 
echo "  âœ… Docker image built successfully"
'''

[tasks."release:tag"]
description = "Tag Docker image with version"
run = '''
if [ -z "$VERSION" ]; then
  echo "âŒ ERROR: VERSION not set"
  echo "Usage: VERSION=1.0.0 mise run release:tag"
  exit 1
fi
docker tag $DOCKER_IMAGE:$DOCKER_TAG $DOCKER_IMAGE:$VERSION
echo "âœ… Tagged image as $DOCKER_IMAGE:$VERSION"
'''

# Utility Tasks
[tasks.env]
description = "Show environment variables"
run = '''
echo "Environment Variables:"
echo "IBMCLOUD_API_KEY: ${IBMCLOUD_API_KEY:+***SET***}"
echo "LOG_LEVEL: ${LOG_LEVEL:-INFO}"
echo "PROJECT_NAME: $PROJECT_NAME"
echo "DOCKER_IMAGE: $DOCKER_IMAGE"
'''

[tasks.requirements]
description = "Generate requirements.txt with pinned versions"
run = '''
echo "ðŸ“¦ Generating requirements.txt..."
pip freeze | grep -E "(ibm-code-engine-sdk|mcp)" > requirements.txt
echo "âœ… Requirements saved to requirements.txt"
'''